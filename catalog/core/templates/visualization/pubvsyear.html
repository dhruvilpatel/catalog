{% load static %}
<!DOCTYPE html>
<meta charset="utf-8">

<script src="https://d3js.org/d3.v4.min.js"></script>
<head>
    <title>Visualization</title>
    <meta charset="utf-8"/>


    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>
</head>
<body onload="LoadCountVizualization()">
<p id="Name"></p>
<div class="chart-background" id="donutChart" style="height: 340px; min-width: 20%;  float: left; "></div>
<div class="chart-background" style="min-width:73%; float: right">

    <form action="" style="text-align: center; font-size: 12px; height: 30px; margin-top: 10px">
        <input type="radio" name="type" checked=True value="Count" onclick="LoadCountVizualization()"> Count
        <input type="radio" name="type" value="Percentage" onclick="LoadPercentageVizualization()"> Percentage
    </form>
    <div id="stackedArea" class="c3-text" style="height: 340px"></div>
    <p>Staged Distribution of Publication against year</p>
</div>

<script type="text/javascript">
    var obje = {{ obj_as_json|safe }};
    var platform = {{ code_platform|safe }};
    var id = obje[0]['id'];
    var name = obje[0]['name'];


    var ls = [];
    for (var key in platform[0]) {
        ls.push(key)
    }
    console.log(id);

    function donutChart() {
        var chart = c3.generate({
            data: {

                json: platform,
                mimeType: 'json',
                keys: {
                    value: ls
                },
                type: 'donut',
                onclick: function (d, i) {
                    console.log("onclick", d, i);
                },
                onmouseover: function (d, i) {
                    console.log("onmouseover", d, i);
                },
                onmouseout: function (d, i) {
                    console.log("onmouseout", d['id']);
                }
            },
            {#            size: {#}
            {#                height: 340,#}
            {#                width: 340#}
            {#            },#}

            donut: {
                label: {
                    format: function (value) {
                        return value;
                    }
                },
                title: "Models Platform"
            },
            bindto: '#donutChart'
        });
    }

    function LoadPercentageVizualization() {
        var svg = d3.select("svg");
        svg.selectAll("*").remove();
        c3.chart.internal.fn.getInterpolate = () => 'monotone';
        donutChart();
        var chart1 = c3.generate({
            data: {
                json: obje,
                mimeType: 'json',
                types: {
                    'Code Available Per': 'area-spline',
                    'Code Not Available Per': 'area-spline'
                },
                groups: [['Code Available Per', 'Code Not Available Per']],
                keys: {
                    x: 'date',
                    value: ['Code Available Per', 'Code Not Available Per'],
                },
                {#        names: {#}
                {#            'Code Available': 'Name 1',#}
                {#            'Code Not Available': 'Name 2'#}
                {#        }#}
                onclick: function (e) {
                    alert(e.value);
                }
            },
            legend: {
                show: true,
                position: 'inset',
                inset: {
                    anchor: 'top-right',
                    x: 50,
                    y: undefined,
                    step: undefined
                }
            },
            {#        size: {#}
            {#            height: 340,#}
            {#            width: 1000#}
            {#        },#}
            axis: {
                x: {
                    padding: {left: 0, top: 0},
                    tick: {
                        culling: {
                            max: 40 // the number of tick texts will be adjusted to less than this value
                        },
                        fit: true,
                        format: "%y"
                    },
                    label: {
                        text: 'Year',
                        position: 'outer-center'
                    },
                    onclick: function (d, i) {
                        console.log("onclick", d, i);
                    },
                    onmouseover: function (d, i) {
                        console.log("onmouseover", d, i);
                    },
                    onmouseout: function (d, i) {
                        console.log("onmouseout", d['id']);
                    }
                },
                y: {
                    max: 99,
                    label: {
                        text: 'Percentage',
                        position: 'outer-middle'
                    },
                    tick: {
                        format: function (d) {
                            return d + "%";
                        }
                    }
                }
            },
            point: {
                show: false,
            },
            tooltip: {
                format: {
                    title: function (d) {
                        return 'Percentage data for ' + d;
                    },
                    value: function (value, ratio, id) {
                        return (value).toFixed(2) + '%';
                    }
//            value: d3.format(',') // apply this format to both y and y2
                }
            },
            bindto: '#stackedArea'
        });
        d3OnClickEvent()
    }

    function LoadCountVizualization() {
        document.getElementById('Name').innerHTML = name;
        donutChart();
        c3.chart.internal.fn.getInterpolate = () => 'monotone';
        console.log(obje)
        var chart1 = c3.generate({

            data: {

                json: obje,
                mimeType: 'json',
                selection: {
                    enabled: true
                },
                onselected: function (d, element) {
                    console.log(d['x']);
                    callUrl(id, name, d['x'])
                },
                types: {
                    'Code Available': 'area-spline',
                    'Code Not Available': 'area-spline'
                },
                groups: [['Code Available', 'Code Not Available']],
                keys: {
                    x: 'date',
                    value: ['Code Available', 'Code Not Available'],
                },
                {#        names: {#}
                {#            'Code Available': 'Name 1',#}
                {#            'Code Not Available': 'Name 2'#}
                {#        }#}

            },
            legend: {
                show: true,
                position: 'inset',
                inset: {
                    anchor: 'top-right',
                    x: 50,
                    y: undefined,
                    step: undefined
                }
            },
            {#                size: {#}
            {#                    height: 340,#}
            {#                    width: 1000#}
            {#                },#}
            axis: {
                x: {
                    padding: {left: 0},
                    tick: {
                        culling: {
                            max: 40 // the number of tick texts will be adjusted to less than this value
                        },
                        fit: true,
                        format: "%y"
                    },

                    label: {
                        text: 'Year',
                        position: 'outer-center'
                    }

                },
                y: {
                    label: {
                        text: 'Number of publication',
                        position: 'outer-middle'
                    },

                    tick: {
                        format: function (d) {
                            return d;
                        }
                    }
                }
            },
            bindto: '#stackedArea'
        });

        d3OnClickEvent()
    }

    function d3OnClickEvent() {
        d3.selectAll('.tick').on({
            "mouseover": function () { /* do stuff */
            },
            "mouseout": function () { /* do stuff */
            },
            "click": function (value, index) {
                callUrl(id, name, value)
            },
        });
    }

    function callUrl(id, name, value) {
        console.log(id, name, value);

        var url = "{% url 'core:publicationlist' id="1" name="name" year="value" %}".replace(/1/, id).replace(/name/, name).replace(/value/, value);
        location.href = url
        //window.history.pushState("", "", url);
    }


</script>

</body>